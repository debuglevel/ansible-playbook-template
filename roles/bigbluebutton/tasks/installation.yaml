- name: Ensure /_deployment/installation/
  file:
    path: /_deployment/installation/
    state: directory

- name: Download bbb-install.sh
  get_url:
    url: https://ubuntu.bigbluebutton.org/bbb-install.sh
    dest: /_deployment/installation/
    force: true # Always download and update the file
    mode: "0770"

# - name: Disable memory check in bbb-install.sh
#   lineinfile:
#     path: /_deployment/installation/bbb-install.sh
#     regexp: "^  check_mem$"
#     state: absent

- name: Get hostname
  command: hostname -f
  register: hostname
  changed_when: false
- name: Save hostname
  set_fact:
    hostname: "{{ hostname.stdout }}"
- name: Print hostname
  debug:
    var: hostname

- name: Run bbb-install.sh
  command:
    argv:
      - /_deployment/installation/bbb-install.sh
      - "{{ '-w' if bigbluebutton_install_firewall == true else '' }}"
      - -v
      - "{{ bigbluebutton_version }}"
      - -s
      - "{{ hostname }}"
      - "{{ '-g' if bigbluebutton_install_greenlight == true else '' }}"
      - "{{ '-e'                            if bigbluebutton_use_letsencrypt == true else '' }}"
      - "{{ bigbluebutton_letsencrypt_email if bigbluebutton_use_letsencrypt == true else '' }}"
      - "{{ '-c'                                                            if bigbluebutton_use_coturn == true else '' }}"
      - "{{ bigbluebutton_coturn_server + ':' + bigbluebutton_coturn_secret if bigbluebutton_use_coturn == true else '' }}"
  tags:
    - installation
    - long-running
